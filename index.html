
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NPPF Step Two – Sergeants Mock Exam (v6.1)</title>
<style>
:root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b; }
* { box-sizing: border-box; }
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial;}
header{padding:20px 24px;border-bottom:1px solid #374151;background:#0b1220;position:sticky;top:0;z-index:10}
h1{margin:0;font-size:1.4rem}
main{max-width:980px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid #374151;border-radius:14px;padding:16px;margin-bottom:16px}
label{display:block;margin:8px 0 4px}
input[type="number"], select{width:100%;padding:10px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:var(--text)}
button{background:var(--accent);color:#001b2b;border:none;border-radius:10px;padding:12px 16px;cursor:pointer;font-weight:600}
button.secondary{background:#334155;color:#e5e7eb}
.row{display:flex;gap:12px;flex-wrap:wrap}
.row > *{flex:1}
.q{margin:18px 0;padding:16px;border-radius:12px;background:#0b1220;border:1px solid #374151}
.q h3{margin-top:0}
.meta{display:flex;gap:8px;flex-wrap:wrap;font-size:0.9rem;color:var(--muted)}
.meta .pill{background:#0f172a;border:1px solid #374151;border-radius:999px;padding:4px 8px}
.scenario{background:#0f172a;border:1px dashed #374151;border-radius:10px;padding:12px;margin:12px 0}
.question{font-style:italic;margin:8px 0}
.options{display:grid;grid-template-columns:1fr;gap:10px;margin-top:8px}
.opt{display:flex;align-items:center;justify-content:flex-start;gap:10px;width:100%;text-align:left;padding:14px;border-radius:10px;border:1px solid #374151;background:#0f172a;color:var(--text);min-height:48px}
.opt .opt-label{font-weight:700;min-width:2.2ch}
.opt .opt-text{flex:1}
.opt .marker{margin-left:auto;font-weight:700}
.opt.correct{border-color:var(--good)}
.opt.correct .marker{color:var(--good)}
.opt.incorrect{border-color:var(--bad)}
.opt.incorrect .marker{color:var(--bad)}
.opt.disabled{opacity:0.8;cursor:not-allowed}
.explain{padding:12px;border-left:4px solid #374151;margin-top:8px;background:#0f172a}
.hidden{display:none}
.muted{color:var(--muted)}
.status{margin-top:8px;color:var(--muted)}
.timer{position:sticky;top:64px;background:#0b1220;border:1px solid #374151;border-radius:10px;padding:8px 12px;margin-bottom:12px;color:#93c5fd}
.warn{color:var(--warn)}
.footer{margin-top:8px;font-size:0.85rem;color:#9ca3af}
@media (max-width:480px){ h1{font-size:1.2rem} .opt{padding:16px} button{width:100%} }
</style>
</head>
<body>
<header>
  <h1>NPPF Step Two – Sergeants Mock Exam (v6.1)</h1>
  <div class="muted">Mobile optimised · Delegated click handling · Clear A–D labelling</div>
</header>
<main>
  <section class="card" id="settings">
    <h2>Exam Settings</h2>
    <div class="row">
      <div>
        <label for="qCount">Number of questions</label>
        <input type="number" id="qCount" min="5" max="120" value="30" />
      </div>
      <div>
        <label for="mode">Mode</label>
        <select id="mode">
          <option value="study">Study (feedback + explanation after each question)</option>
          <option value="test">Test (feedback now; explanations at end)</option>
          <option value="mock">Mock Exam (timed; feedback now; explanations at end)</option>
        </select>
      </div>
      <div>
        <label for="minutes">Time limit (minutes)</label>
        <input type="number" id="minutes" min="5" max="180" value="45" />
      </div>
    </div>
    <div class="row">
      <div>
        <label><input type="checkbox" id="shuffle" checked> Shuffle options</label>
      </div>
      <div>
        <label><input type="checkbox" id="unique" checked> Avoid repeating scenarios (this session)</label>
      </div>
    </div>
    <div class="row">
      <button id="startBtn">Start Exam</button>
      <button class="secondary" id="finishBtn">Finish & Score</button>
      <button class="secondary" id="resetUsed">Reset used scenarios</button>
    </div>
    <div id="status" class="status"></div>
  </section>

  <section class="card hidden" id="exam"></section>
  <section class="card hidden" id="results"></section>
</main>

<script>
(function(){
  // Utilities
  const rnd = n => Math.floor(Math.random()*n);
  const pick = arr => arr[rnd(arr.length)];
  const shuffle = arr => { for(let i=arr.length-1;i>0;i--){ const j=rnd(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; };

  // Pools
  const ROLES=['Sgt','PS','PC','T/DS','DC'];
  const NAMES=['Parish','Malone','Doherty','Smith','Jones','Patel','Owen','McKay','Ahmed','Brown','Williams','Hughes','Taylor','Green'];
  const LOCS=['High Street','Towpath','Park Gate','Bus Station','Shopping Arcade','School Entrance','Estate Courtyard','Canal Bridge','Retail Park','Railway Station','Market Square','Community Centre'];
  const ITEMS=['lock knife','screwdriver','baton','metal bar','spray can','bolt cutters','laptop','phone','wallet'];
  const TIMES=['08:10','10:45','12:15','14:30','16:00','19:05','22:10'];
  const AGES=['9','10','12','15','16','17'];
  const WEATHER=['dry','rainy','overcast'];
  const VEHICLES=['car','van','motorcycle'];

  function T(id,title,leg,scenario,question,options,correct,explain,vars){
    return {id,title,legislation:leg,scenarioTemplate:scenario,questionText:question,options,correctIndex:correct,explanation:explain,variables:vars||{}};
  }

  const TEMPLATES=[];
  function addCore(){
    TEMPLATES.push(T('PACE_A_01','PACE Code A – Intel vs objective grounds','PACE Code A','At {Time} in {Weather} conditions, {Role} {Name} observes {Count} youths near {Location}. Recent intel suggests trios of gang members habitually carry knives. One youth adjusts his waistband; another scans the area repeatedly. Ages appear {Age1}, {Age2}, {Age3}. Officers have BWV active and a supervisor available by radio.','Under Code A, which approach is correct?',[
      'Search all three based solely on gang intel',
      'Each search must be justified by individual objective grounds; intel may inform but is not determinative',
      'Only those aged 10+ can be searched lawfully under s1 PACE',
      'Tattoos or intel cannot be considered at all'
    ],1,'Code A requires objective, individual grounds (e.g., concealment behaviours). Intel can inform grounds but does not create a blanket power.',{Time:TIMES,Weather:WEATHER,Role:ROLES,Name:NAMES,Count:['3'],Location:LOCS,Age1:AGES,Age2:AGES,Age3:AGES}));

    TEMPLATES.push(T('CODEC_01','Code C – Solicitor requested','PACE Code C','At {Time}, a detainee states they want a solicitor before interview. The OIC cites workload pressure and proposes to proceed.','Which is correct?',[
      'Interview must be delayed unless a recorded Code C exception applies',
      'Proceed while advice is arranged',
      'Legal advice is discretionary',
      'Only written advice is allowed'
    ],0,'Code C provides an unqualified right to legal advice; exceptions are narrowly defined and must be recorded.',{Time:TIMES}));

    TEMPLATES.push(T('CODED_01','Code D – Street identification','PACE Code D','After an assault at {Location}, a witness spontaneously points out a person minutes later. The officer considers a street identification.','Which is correct?',[
      'Street ID is informal; follow Code D safeguards and record details',
      'Street ID is a formal video parade replacement',
      'Street ID is inadmissible unless filmed',
      'Street ID cannot occur if the suspect denies involvement'
    ],0,'Street IDs are informal but recognised in Code D; documentation and safeguards are required.',{Location:LOCS}));

    TEMPLATES.push(T('EVID_78_01','PACE s78 – Excluding evidence','PACE s78','During a search at {Location}, an officer arguably exceeded the scope of a warrant and seized a {Item}. The defence challenges admissibility.','Which principle applies?',[
      'Evidence may be excluded if its admission would adversely affect the fairness of proceedings',
      'Improperly obtained evidence is automatically excluded',
      'All evidence seized under any warrant is admissible regardless',
      'CPS decides admissibility without court involvement'
    ],0,'Under s78 PACE, courts may exclude evidence if admission would adversely affect fairness. Improperly obtained evidence is not automatically excluded.',{Location:LOCS,Item:ITEMS}));

    TEMPLATES.push(T('MODA_23_01','MoDA s23 – Drug search grounds','Misuse of Drugs Act 1971','At {Time} near {Location}, {Role} {Name} observes furtive exchanges and smells cannabis. A suspect has dilated pupils and attempts to walk off.','Which power applies?',[
      's23 MoDA – search of person/premises based on reasonable grounds',
      'PACE s1 only',
      'No search without arrest',
      'Warrant under s8 PACE required'
    ],0,'s23 provides search powers for controlled drugs where reasonable grounds exist (behaviour, smell, observations).',{Time:TIMES,Location:LOCS,Role:ROLES,Name:NAMES}));

    TEMPLATES.push(T('OAPA_20_01','OAPA – s20 GBH without intent','OAPA 1861','During a street fight at {Location}, {Name} swings a {Item} causing serious injury but no clear intent to cause GBH.','Most appropriate charge?',[
      's20 – inflict GBH/wounding without intent',
      's18 – cause GBH with intent',
      'ABH – s47',
      'Common assault'
    ],0,'s20 requires serious harm/wounding without specific intent to cause GBH; s18 requires intent.',{Location:LOCS,Name:NAMES,Item:['metal bar','bottle','wooden baton']}));

    TEMPLATES.push(T('RTA_163_01','RTA – Power to stop vehicles','RTA 1988','At {Time} on the {Location} access road, {Role} {Name} signals a {Vehicle} to stop. The driver continues slowly for 200m before stopping.','Which is correct?',[
      's163 requires a driver to stop when required by a constable; failing to stop is an offence',
      'Stopping is discretionary unless an offence suspected',
      'Power applies only on motorways',
      'Power applies only with written authority'
    ],0,'s163 RTA provides a general power requiring drivers to stop on request; failure is an offence.',{Time:TIMES,Location:LOCS,Role:ROLES,Name:NAMES,Vehicle:VEHICLES}));
  }

  addCore();

  // Add variants to reach ~40 for demo (you can add more templates similarly)
  const base = TEMPLATES.slice();
  const need = 40 - TEMPLATES.length;
  for(let i=0;i<need;i++){
    const b = base[i % base.length];
    TEMPLATES.push(T(
      b.id+'_V'+(i+1),
      b.title+' (Variant '+(i+1)+')',
      b.legislation,
      b.scenarioTemplate + ' Officers have BWV active and a supervisor available by radio.',
      b.questionText,
      b.options,
      b.correctIndex,
      b.explanation,
      b.variables
    ));
  }

  function fillPlaceholders(tpl){
    const pools = {Role:ROLES, Name:NAMES, Location:LOCS, Item:ITEMS, Time:TIMES, Age:AGES, Age1:AGES, Age2:AGES, Age3:AGES, Weather:WEATHER, Vehicle:VEHICLES, Count:['2','3','4','5']};
    const vars = tpl.variables || {};
    const picks = {};
    for(const key of Object.keys(pools)){
      const source = vars[key] || pools[key];
      picks[key] = pick(source);
    }
    let scenario = tpl.scenarioTemplate;
    for(const [k,v] of Object.entries(picks)){
      scenario = scenario.replace(new RegExp('\\{'+k+'\\}', 'g'), v);
    }
    const variantKey = tpl.id + '|' + Object.values(picks).join('|');
    return {scenario, variantKey};
  }

  // Session uniqueness
  const usedVariants = new Set();

  function buildPaper(requested, avoidRepeat){
    const statusEl = document.getElementById('status');
    const total = TEMPLATES.length;
    let count = Math.min(requested, total);
    if(requested > total){ statusEl.innerHTML = `<span class="warn">Requested ${requested} exceeds available (${total}). Capped at ${total}.</span>`; }
    else { statusEl.textContent = `Generating ${count} unique questions.`; }
    const order = shuffle(TEMPLATES.slice());
    const paper = [];
    for(const tpl of order){
      if(paper.length >= count) break;
      const {scenario, variantKey} = fillPlaceholders(tpl);
      if(avoidRepeat && usedVariants.has(variantKey)) continue;
      usedVariants.add(variantKey);
      paper.push({ id:tpl.id, title:tpl.title, legislation:tpl.legislation, scenario:scenario, question:tpl.questionText, options:tpl.options.slice(), correctIndex:tpl.correctIndex, explanation:tpl.explanation });
    }
    return paper;
  }

  // UI wiring with delegated click handling
  const examEl=document.getElementById('exam');
  const resultsEl=document.getElementById('results');
  const startBtn=document.getElementById('startBtn');
  const finishBtn=document.getElementById('finishBtn');
  const resetBtn=document.getElementById('resetUsed');
  const qCountEl=document.getElementById('qCount');
  const modeEl=document.getElementById('mode');
  const minutesEl=document.getElementById('minutes');
  const shuffleEl=document.getElementById('shuffle');
  const uniqueEl=document.getElementById('unique');

  let state={paper:[],answers:[],mode:'study',timer:null};

  function startExam(){
    const requested = parseInt(qCountEl.value||'30',10);
    const avoid = uniqueEl.checked;
    const paper = buildPaper(requested, avoid);
    state.paper = paper;
    state.answers = Array(paper.length).fill(null);
    state.mode = modeEl.value;

    examEl.classList.remove('hidden');
    resultsEl.classList.add('hidden');
    examEl.innerHTML = '';

    let idx=0;
    for(const q of paper){
      const wrap = document.createElement('div'); wrap.className='q'; wrap.setAttribute('data-q', String(idx));
      const meta = `<div class="meta"><span class="pill">${q.legislation}</span><span class="pill">Scenario-driven</span></div>`;
      wrap.innerHTML = `<h3>Q${idx+1}. ${q.title}</h3>${meta}<div class="scenario">${q.scenario}</div><p class="question">${q.question}</p>`;

      const optsWrap = document.createElement('div'); optsWrap.className = 'options';
      let opts = q.options.map((t,i)=>({text:t,idx:i}));
      if(shuffleEl.checked) opts = shuffle(opts);
      // Render options with sequential A–D labels by position, but keep original idx for correctness mapping
      opts.forEach((o,pos)=>{
        const label = String.fromCharCode(65+pos);
        const b=document.createElement('button'); b.className='opt'; b.type='button';
        b.setAttribute('data-idx', String(o.idx)); b.setAttribute('data-pos', String(pos));
        b.innerHTML = `<span class="opt-label">${label})</span><span class="opt-text">${o.text}</span><span class="marker" aria-hidden="true"></span>`;
        optsWrap.appendChild(b);
      });
      wrap.appendChild(optsWrap);

      const exp=document.createElement('div'); exp.className='explain hidden'; exp.innerHTML='<strong>Explanation:</strong> '+q.explanation; wrap.appendChild(exp);
      examEl.appendChild(wrap);
      idx++;
    }

    // Timer for mock mode
    if(state.mode==='mock'){
      const mins = parseInt(minutesEl.value||'45',10);
      const endTime = Date.now() + mins*60*1000;
      const timerBar = document.createElement('div'); timerBar.className='timer'; examEl.prepend(timerBar);
      state.timer = setInterval(()=>{
        const left = Math.max(0, endTime - Date.now());
        const m = Math.floor(left/60000), s = Math.floor((left%60000)/1000);
        timerBar.textContent = `Time left: ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        if(left<=0){ clearInterval(state.timer); finishExam(true); }
      }, 500);
    }
  }

  // Delegated click handler for answers (works reliably on mobile/desktop)
  examEl.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('button.opt');
    if(!btn) return;
    const qWrap = btn.closest('.q');
    if(!qWrap) return;
    const qIndex = parseInt(qWrap.getAttribute('data-q'),10);
    if(state.answers[qIndex]!==null) return; // already answered
    const q = state.paper[qIndex];
    const ansIndex = parseInt(btn.getAttribute('data-idx'),10);
    state.answers[qIndex] = ansIndex;

    const buttons = Array.from(qWrap.querySelectorAll('button.opt'));
    buttons.forEach(b=>{ b.classList.add('disabled'); b.classList.add('incorrect'); b.disabled=true; });
    const correctBtn = buttons.find(b => parseInt(b.getAttribute('data-idx'),10) === q.correctIndex);
    if(correctBtn){ correctBtn.classList.remove('incorrect'); correctBtn.classList.add('correct'); }
    if(state.mode==='study'){ const exp = qWrap.querySelector('.explain'); if(exp) exp.classList.remove('hidden'); }
  });

  function finishExam(auto=false){
    if(state.mode!=='study'){
      document.querySelectorAll('.explain').forEach(el=>el.classList.remove('hidden'));
    }
    let correct=0; for(let i=0;i<state.paper.length;i++){ if(state.answers[i]===state.paper[i].correctIndex) correct++; }
    const unanswered = state.answers.filter(a=>a===null).length;
    const pct = Math.round((correct/state.paper.length)*100);
    resultsEl.classList.remove('hidden');
    resultsEl.innerHTML = `<h2>Results</h2><p><strong>Score:</strong> ${correct}/${state.paper.length} (${pct}%) · Unanswered: ${unanswered}</p><p class="muted">Mode: ${state.mode}${auto?' · Auto-submitted on time':''}</p>`;
    if(state.timer) clearInterval(state.timer);
  }

  document.getElementById('startBtn').addEventListener('click', startExam);
  document.getElementById('finishBtn').addEventListener('click', ()=> finishExam(false));
  document.getElementById('resetUsed').addEventListener('click', ()=>{ usedVariants.clear(); alert('Used scenario tracker cleared for this session.'); });
})();
</script>
<footer style="max-width:980px;margin:0 auto;padding:24px;color:#9ca3af;font-size:0.85rem">
  <p><strong>Note:</strong> This v6.1 build fixes click handling by using delegated events and shows A–D labels in positional order while keeping the original correctness mapping.</p>
</footer>
</body>
</html>
